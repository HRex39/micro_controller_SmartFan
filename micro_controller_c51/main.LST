C51 COMPILER V9.00   MAIN                                                                  12/23/2020 17:26:41 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: E:\Keil4\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          //SmartFan
   2          //HRex 2020/12/23
   3          #include <reg52.h>
   4          #include "fan.h"
   5          
   6          uint8 Buf[]="hello world!\n";
   7          uint8 Received_Buf[50] = '0';
   8          uint16 num = 0;
   9          //Flags
  10          FAN_FLAG = 0;
  11          
  12          //LED
  13          sbit LED_DIN = P1^5;
  14          sbit LED_CS = P1^6;
  15          sbit LED_CLK = P1^7;
  16          //KeyBoard
  17          sbit K1 = P3^2;
  18          sbit K2 = P3^3;
  19          sbit K3 = P3^6;
  20          sbit K4 = P3^7;
  21          
  22          
  23          void UART_Init() {
  24   1        TMOD = 0x20;
  25   1        TMOD = 0x20; //定时器0工作模式2，自动重装8位计数器
  26   1        TH1 = 0xfd;
  27   1        TL1 = 0xfd;//定时器溢出时，会自动将高8位中的值赋值给低8位.比特率9600
  28   1        TR1 = 1;
  29   1        SM0 = 0;
  30   1        SM1 = 1;
  31   1        REN = 1;
  32   1        EA = 1;
  33   1        ES = 1;
  34   1      }
  35          
  36          /*发送一个字符*/
  37          void UART_send_byte(uint8 dat) {
  38   1        SBUF = dat;           //把数据放到SBUF中
  39   1        while (TI == 0);              //未发送完毕就等待
  40   1        TI = 0;                       //发送完毕后，要把TI重新置0
  41   1      }
  42           
  43          /*发送一个字符串*/
  44          void UART_send_string(uint8 *buf) {
  45   1        while (*buf != '\0') {
  46   2          UART_send_byte(*buf++);
  47   2        }
  48   1      }
  49          
  50          /*异步通信中断*/
  51          void UART() interrupt 4 {
  52   1        if(RI == 1) {
  53   2              int i = 0;//计数器
  54   2              num = SBUF;  //取出数据
  55   2              while (num != '!') {
C51 COMPILER V9.00   MAIN                                                                  12/23/2020 17:26:41 PAGE 2   

  56   3                Received_Buf[i] = num;
  57   3                RI = 0;
  58   3                delay(1);
  59   3                num = SBUF;
  60   3                i++;    
  61   3              }
  62   2              Received_Buf[i] = '!';
  63   2              Received_Buf[i+1] = '\0'; 
  64   2              RI = 0;
  65   2              //JUDGE FANS STAGE
  66   2              if (Received_Buf[4] == '0') FAN_FLAG = 0;
  67   2              else if (Received_Buf[4] == '1') FAN_FLAG = 1;
  68   2              else if (Received_Buf[4] == '2') FAN_FLAG = 2;
  69   2              else if (Received_Buf[4] == '3') FAN_FLAG = 3;
  70   2              else FAN_FLAG = 0;
  71   2      
  72   2              UART_send_string(Received_Buf);
  73   2              for (i=49;i>0;i--)
  74   2                Received_Buf[i] = 0;
  75   2        }
  76   1        //如果发送完毕
  77   1        if(TI == 1) {                                                    
  78   2          TI = 0;       //清除标志位
  79   2        }
  80   1      }
  81          
  82          void main() {
  83   1              
  84   1        UART_Init();
  85   1        while (1) {
  86   2          
  87   2              switch(FAN_FLAG) {
  88   3                case 0: fan_stop();break;
  89   3                case 1: fan_low();break;
  90   3                case 2: fan_mid();break;
  91   3                case 3: fan_high();break;
  92   3                default:fan_stop();break;
  93   3              }// switch
  94   2      
  95   2        }     
  96   1      
  97   1      
  98   1      }// main
  99          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    465    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     68       5
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
