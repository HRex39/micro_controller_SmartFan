C51 COMPILER V9.00   MAIN                                                                  12/24/2020 12:17:54 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: E:\Keil4\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          //SmartFan
   2          //HRex 2020/12/23
   3          #include <reg52.h>
   4          #include "types.h"
   5          #include "fan.h"
   6          #include "led.h"
   7          #include "key.h"
   8          
   9          uint8 Buf[]="hello world!\n";
  10          uint8 Received_Buf[50] = '0';
  11          uint16 num = 0;
  12          
  13          void UART_Init() {
  14   1        TMOD = 0x20;
  15   1        TMOD = 0x20; //定时器0工作模式2，自动重装8位计数器
  16   1        TH1 = 0xfd;
  17   1        TL1 = 0xfd;//定时器溢出时，会自动将高8位中的值赋值给低8位.比特率9600
  18   1        TR1 = 1;
  19   1        SM0 = 0;
  20   1        SM1 = 1;
  21   1        REN = 1;
  22   1        EA = 1;
  23   1        ES = 1;
  24   1      }
  25          
  26          /*发送一个字符*/
  27          void UART_send_byte(uint8 dat) {
  28   1        SBUF = dat;           //把数据放到SBUF中
  29   1        while (TI == 0);              //未发送完毕就等待
  30   1        TI = 0;                       //发送完毕后，要把TI重新置0
  31   1      }
  32           
  33          /*发送一个字符串*/
  34          void UART_send_string(uint8 *buf) {
  35   1        while (*buf != '\0') {
  36   2          UART_send_byte(*buf++);
  37   2        }
  38   1      }
  39          
  40          /*异步通信中断*/
  41          void UART() interrupt 4 {
  42   1        if(RI == 1) {
  43   2              int i = 0;//计数器
  44   2              num = SBUF;  //取出数据
  45   2              while (num != '!') {
  46   3                Received_Buf[i] = num;
  47   3                RI = 0;
  48   3                delay(1);
  49   3                num = SBUF;
  50   3                i++;    
  51   3              }
  52   2              Received_Buf[i] = '!';
  53   2              Received_Buf[i+1] = '\0'; 
  54   2              RI = 0;
  55   2              //JUDGE FANS STAGE
C51 COMPILER V9.00   MAIN                                                                  12/24/2020 12:17:54 PAGE 2   

  56   2              if (Received_Buf[4] == '0') FAN_FLAG = 0;
  57   2              else if (Received_Buf[4] == '1') FAN_FLAG = 1;
  58   2              else if (Received_Buf[4] == '2') FAN_FLAG = 2;
  59   2              else if (Received_Buf[4] == '3') FAN_FLAG = 3;
  60   2              else FAN_FLAG = 0;
  61   2              //JUDGE TIME
  62   2              if (Received_Buf[0] > '6') TIME_FLAG = 0;
  63   2              else TIME_FLAG = 1;
  64   2              if (TIME_FLAG) {
  65   3                TIME_MIN = (Received_Buf[0] - 0x30) * 10 + (Received_Buf[1]-0x30);
  66   3                TIME_SEC = (Received_Buf[2] - 0x30) * 10 + (Received_Buf[3]-0x30);
  67   3              } 
  68   2              UART_send_string(Received_Buf);
  69   2              for (i=49;i>0;i--)
  70   2                Received_Buf[i] = 0;
  71   2        }
  72   1        //如果发送完毕，清除标志位
  73   1        if(TI == 1) {                                                    
  74   2          TI = 0;       
  75   2        }
  76   1      }
  77          
  78          void main() {
  79   1              
  80   1        UART_Init();
  81   1        while (1) {
  82   2          key_select();
  83   2          switch(FAN_FLAG) {
  84   3                case 0: fan_stop();break;
  85   3                case 1: fan_low();break;
  86   3                case 2: fan_mid();break;
  87   3                case 3: fan_high();break;
  88   3                default:fan_stop();break;
  89   3              }// switch
  90   2      
  91   2      
  92   2        }// while
  93   1      }// main
  94          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    641    ----
   CONSTANT SIZE    =     18    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     80       5
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
